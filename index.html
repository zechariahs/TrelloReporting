<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		
		<title>Trello Report Generator</title>
		
		<!-- <script src="js/jquery-2.0.3.js"></script> -->
		<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
		<script src="https://api.trello.com/1/client.js?key=XXX"></script>
		
		<script type="text/javascript">
			
			var trelloAPIKey = "XXX";
			var trelloSecretAPIKey = "XXX";
			
			var selectedBoard;
			var lists;
			var actions;
			var members;
			var cards;
			
			var listsLoaded = false;
			var actionsLoaded = false;
			var membersLoaded = false;
			var cardsLoaded = false;
			
			$("#authorize_page").click(requestAuthorization);
			
			Trello.authorize
			({
				interactive:false
				, success: onAuthorize
			});
			
			
			var requestAuthorization = function ()
			{
				
				console.log("Requesting authorization");
				
				Trello.authorize
				({
					name: "Trello Reporting"
					//, type:"popup"
					, success: onAuthorize
					, error: onAuthorizationError
					, scope:
					{
						read: true
						, write: false
						, account: true
					}
				});
				
				
			};
			
			var onAuthorize = function()
			{
				
				console.log("Have authorization");
				
				updateLoggedIn();
				
				Trello.members.get("my/boards/all"
					, function(boards)
					{
						parseBoards(boards);
					}
				);
			}
			
			var onAuthorizationError = function()
			{
				alert("Not Authorized!");
			}
			
			var updateLoggedIn = function() 
			{
				var isLoggedIn = Trello.authorized();
				//$("#loggedout").toggle(!isLoggedIn);
				//$("#loggedin").toggle(isLoggedIn);        
			};
			
			function prepareReport(clean)
			{
				if(clean)
				{
					selectedBoard = null;
					lists = null;
					actions = null;
					members = null;
					cards = null;
					
					listsLoaded = false;
					actionsLoaded = false;
					membersLoaded = false;
					cardsLoaded = false;
					
				}
				
				$("#data").empty();
				
				var boardId = $("#selected_board").val();
				
				if(selectedBoard == null)
				{
					Trello.boards.get(boardId
						, function(board)
						{
							parseBoard(board);
						}
					);
				}
				
				if(lists == null)
				{
				
					Trello.boards.get(boardId + "/lists"
						, function(lists)
						{
							parseLists(lists);
							renderReport();
						}
					);
				}
				
				if(actions == null)
				{
					Trello.boards.get(boardId + "/actions?filter=createCard,commentCard,addAttachmentToCard"
						, function(actions)
						{
							parseActions(actions);
							renderReport();
						}
					);
				}
				
				
				if(members == null)
				{
					Trello.boards.get(boardId + "/members"
						, 
						{
							fields: "all"
						}
						, function(members)
						{
							parseMembers(members);
							renderReport();
						}
					);
				}
				
				if(cards == null)
				{
					Trello.boards.get(boardId + "/cards"
						, function(cards)
						{
							parseCards(cards);
							renderReport();
						}
					);
				}
			}
			
			function parseBoard(board)
			{
				var json = board;
				selectedBoard = json;
			}
			
			function parseBoards(boards)
			{
				var json = boards;
				var json_parsed = $.parseJSON(json);
				
				for(var i = 0; i < json.length; i++)
				{
					$("#selected_board").append("<option value=\"" + json[i].id + "\">" + json[i].name + "</option>");
				}
			
			}
			
			function getFileExtension(filename)
			{
				return filename.substring(filename.lastIndexOf(".") + 1);
			}
			
			function parseLists(json_parsed)
			{
				console.log("Have " + json_parsed.length + " Lists: " + json_parsed);
				lists = json_parsed;
				
				listsLoaded = true;
				
			}
			
			function parseActions(json_parsed)
			{
				console.log("Have " + json_parsed.length + " Actions: " + json_parsed);
				actions = json_parsed;
				
				actionsLoaded = true;
				
			}
			
			function parseMembers(json_parsed)
			{
				console.log("Have " + json_parsed.length + " Members: " + json_parsed);
				members = json_parsed;
				
				membersLoaded = true;
								
			}
			
			function parseCards(json_parsed)
			{
				console.log("Have " + json_parsed.length + " Cards: " + json_parsed);
				cards = json_parsed;
				
				cardsLoaded = true;
				
			}
			
			function getListById(listId)
			{
					for(var i = 0; i < lists.length; i++)
					{
						var list = lists[i];
						
						if(list.id == listId)
						{
							return list.name;
						}	
					}
					
					return null;
			}
			
			function getMemberById(memberId)
			{
					for(var i = 0; i < members.length; i++)
					{
						var member = members[i];
						
						if(member.id == memberId)
						{
							return member;
						}
					}
					
					console.log("Can't find member with id: " + memberId);
					
					return null;
			}
			
			function renderReport()
			{
				
				$("#data").empty();
				
				if(!listsLoaded
					|| !actionsLoaded
					|| !membersLoaded
					|| !cardsLoaded)
				{
					return;
				}
				
				try
				{
					
					$("#data").append("<div class=\"boardName\">" 
							+ selectedBoard.name
							+ "</div>");
							
					$("#data").append("<div class=\"boardDesc\">" 
							+ selectedBoard.desc
							+ "</div>");
					
					$("#data").append("<div id=\"lists_menu\" class=\"menu\"></div>");		
					
					for(var i = 0; i < lists.length; i++)
					{
						var list = lists[i];
						
						$("#data").append("<div class=\"list\" id=\"" + list.id + "\">" 
							+ "<div class=\"listName\"><a id=\"list_menuItem_" + list.id + "\">" + list.name + "</a></div>"
							+ "<div class=\"cardsWrapper\" id=\"cardsWrapper_" + list.id + "\"></div>"
							+ "<div class=\"listFooter\"></div>"
							+ "</div>");
						
						$("#data").append("<div class=\"page-break\"></div>");
						
					}
					
					$("#data").append("<div id=\"membersWrapperWrapper\"</div>");
					$("#membersWrapperWrapper").append("<div id=\"membersWrapper_0\" class=\"membersWrapper\"></div>");
					
					for (var u = 0; u < cards.length; u++)
					{
						var card = cards[u];
						
						var listId = getListById(card.idList);
						
						var cardCssClass;
						
						if(u%2 == 0)
						{
							cardCssClass = "card";
						}
						else
						{
							cardCssClass = "card";
						}
						
						$("#cardsWrapper_" + card.idList).append("<div class=\"" + cardCssClass + "\" id=\"" + card.idShort + "\"></div>")
						
						$("#" + card.idShort).append("<div id=\"" + card.idShort + "_labels" + "\" class=\"cardLabels\">" + "</div>");
						$("#" + card.idShort).append("<div class=\"cardName\">Item #" + card.idShort + ": " + card.name + "</div>");
						$("#" + card.idShort).append("<div class=\"cardDesc\">" + card.desc + "</div>");
						$("#" + card.idShort).append("<div id=\"" + card.idShort + "_comments" + "\" class=\"cardCommentsWrapper\"></div>");
						$("#" + card.idShort).append("<div id=\"" + card.idShort + "_details" + "\" class=\"cardDetails\">" + "</div>");
						$("#" + card.idShort).append("<div id=\"" + card.idShort + "_url" + "\" class=\"cardDetails cardDetails_url\">" 
							+ "<a href=\"" + card.shortUrl + "\">" + card.shortUrl + "</a></div>");
						
						var labels = card.labels;
						
						console.log("Labels: " + labels);
						
						if(labels != null && labels.length > 0)
						{
							for(var labelIdx = 0; labelIdx < labels.length; labelIdx++)
							{
								label = labels[labelIdx];
								
								var labelDivId = "cardLabel_" + card.idShort + "_" + label.color;
								
								$("#" + card.idShort + "_labels").append("<div id=\"" + labelDivId + "\" class=\"cardLabel\">" + label.name + "</div>");
								$("#" + labelDivId).css("background-color", label.color);
								
								if(label.color.toUpperCase() == "RED")
								{
									$("#" + labelDivId).css("color", "#FFFFFF");
								}
								
							}
						}

						
						if(u%4 == 0)
						{
							$("#" + card.idShort).append("<div class=\"page-break\"></div>");
						}
							
					}
					
					//parseActions(json_parsed);
					
					for(var i = 0; i < actions.length; i++)
					{
						var action = actions[i];
						
						if(action.type == "commentCard")
						{
							var cardCommentCSSClass = "cardComment";
							
							var cardDomId = action.data.card.idShort;
							var cardCommentsHolderDomId = action.data.card.idShort + "_comments";
							
							// Determine whether comments DIV has been added, if not create it.  Otherwise, determine the number of comments.
							if($("#" + cardDomId).children("#" + cardCommentsHolderDomId).length > 0)
							{
								var children = $("#" + cardCommentsHolderDomId).children().length;
								
								console.log("Have " + children + " comments.");
								
								if((children + 1)%2 == 0)
								{
									cardCommentCSSClass = "cardComment";
								}
								else
								{
									cardCommentCSSClass = "cardComment";
								}
							}
							
							
							$("#" + cardCommentsHolderDomId).append("<div class=\"" + cardCommentCSSClass + "\" id=\"" + action.id + "\"></div>");
							$("#" + action.id).append("<u>On " + action.date.substring(0, 10) 
								+ " at " + action.date.substring(11, 19) 
								+ " <b>" + getMemberById(action.idMemberCreator).fullName 
								+ "</b> commented</u>: <br/>" + action.data.text);
						}
						else if(action.type == "addAttachmentToCard")
						{
							console.log("Attachment: " + action);
							
							var cardDomId = action.data.card.idShort;
							var cardCommentsHolderDomId = action.data.card.idShort + "_comments";
							var cardCommentCSSClass = "cardComment";
							
							$("#" + cardCommentsHolderDomId).append("<div class=\"" + cardCommentCSSClass + "\" id=\"" + action.id + "\"></div>");
							
							var attachmentDetails = "<u>On " + action.date.substring(0, 10) 
								+ " at " + action.date.substring(11, 19) 
								+ " <b>" + getMemberById(action.idMemberCreator).fullName 
								+ "</b> added an attachment</u>: ";
							
							var fileName = action.data.attachment.name;
							
							if(getFileExtension(fileName).toUpperCase() == "PNG"
								|| getFileExtension(fileName).toUpperCase() == "JPG"
								|| getFileExtension(fileName).toUpperCase() == "JPEG"
								|| getFileExtension(fileName).toUpperCase() == "BMP"
								|| getFileExtension(fileName).toUpperCase() == "GIF")
							{
								attachmentDetails += "<br/><center><a href=\"" + action.data.attachment.url + "\" target=\"_newWindow\">"
									+ "<img class=\"attachmentPreview\" src=\"" + action.data.attachment.previewUrl + "\"/>"
									+ "</a></center>";
							}
							else
							{
								attachmentDetails += "<a href=\"" + action.data.attachment.url + "\" target=\"_newWindow\">"
									+ fileName
									+ "</a>";	
							}
							
							
							
							$("#" + action.id).append(attachmentDetails);
							
						}
						else if(action.type == "createCard")
						{
							
							console.log("Appending " + action.type + " to " + "#" + action.data.card.idShort + "_details");
							
							$("#" + action.data.card.idShort + "_details").append("Created on " + action.date.substring(0, 10) 
								+ " at " + action.date.substring(11, 19) 
								+ " by <b>" + getMemberById(action.idMemberCreator).fullName + "</b>");
						}
						else
						{
							console.log("Nowhere to put " + action.type);
						}
					}
					
					for(var i = 0; i < lists.length; i++)
					{
						var list = lists[i];
						
						if($("#" + "cardsWrapper_" + list.id).children(".card").length == 0)
						{
							$("#" + list.id).append("<center>No cards in this list.</center>");
						}
					}
					
					var menuHtml = "";
					
					for(var i = 0; i < lists.length; i++)
					{
						var list = lists[i];
						
						var cardCount = $("#" + "cardsWrapper_" + list.id).children(".card").length
						
						if(i < (lists.length - 1))
						{
							menuHtml += "<a href=\"#list_menuItem_" + list.id + "\">" + list.name + " (" + cardCount + ")</a> | ";
						}
						else
						{
							menuHtml += "<a href=\"#list_menuItem_" + list.id + "\">" + list.name + " (" + cardCount + ")</a>";
						}
						
						$("#data").append("<div class=\"page-break\"></div>");
						
					}
					
					$("#lists_menu").append(menuHtml);
					
					var wrapperCount = 0;
					
					for(var i = 0; i < members.length; i++)
					{
						var member = members[i];
						
						$("#membersWrapper_" + wrapperCount).append("<div class=\"member\">"
							+ member.fullName
							+ "<br/>"
							+ member.username
							+ " | "
							+ member.initials
							+ "</div>");
							
						if((i+1)%2 == 0)
						{
							var width = jQuery.trim($("div.member").css("width").replace("px", ""));
							var margin = jQuery.trim($("div.member").css("margin").replace("px", ""));
							var wrapperWidth = Number((Number(width) + Number(margin) + (Number(margin) * Number(3))) * Number(members.length));
							$("#membersWrapper_" + wrapperCount).css("width", wrapperWidth + "px");
							
							wrapperCount += 1;
							$("#membersWrapperWrapper").append("<div id=\"membersWrapper_" + wrapperCount + "\" class=\"membersWrapper\"></div>");
						}
						
					}
					
					var width = jQuery.trim($("div.member").css("width").replace("px", ""));
					var margin = jQuery.trim($("div.member").css("margin").replace("px", ""));
					var wrapperWidth = Number((Number(width) + Number(margin) + (Number(margin) * Number(3))) * Number(members.length));
					$("#membersWrapper_" + wrapperCount).css("width", wrapperWidth + "px");
					
					
					
				}
				catch(error)
				{
					alert("Error Rendering Report - " + error.name + ": " + error.message);
				}
				
			}
			
		</script>
		
		<link type="text/css" rel="stylesheet" href="css/default.css" media="screen" />
		<link type="text/css" rel="stylesheet" href="css/print.css" media="print" />
    
	</head>
	
	<body>
		
		<div id="login">
		
			<a id="authorize_page" href="javascript:requestAuthorization();">Authorize Trello Reporting</a>
		
		</div>
		
		<div id="generate">
		
			<form>
			
				<select id="selected_board">
				
				</select>
				
				
				<input type="button" id="generate_report" value="Generate Report" onClick="prepareReport(true);"/>
				<input type="button" id="generate_report" value="Render Report" onClick="renderReport();"/>
				
			</form>
			
		</div>
		
		<div id="data">
		</div>
		
	</body>

</html>